// --------------------------------------------------------
// CONFIGURAÇÕES GERAIS
// --------------------------------------------------------

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql" // Mantido MySQL conforme seu snippet
  url      = env("DATABASE_URL")
}

// --------------------------------------------------------
// ENUMS
// --------------------------------------------------------

// Atualizado para refletir a hierarquia do Dashboard
enum Role {
  ADMIN               // Super Admin (Pleno)
  GESTOR_ORGANIZACAO  // Dono/Gerente da Empresa/Prefeitura
  USUARIO             // Membro comum (Servidor/Participante)
}

enum OrganizationType {
  SYSTEM      // Organização "Mãe" (Seu time Pleno)
  CUSTOMER    // Clientes (Prefeituras, Empresas)
}

enum ActionStatus {
  PENDENTE
  CONCLUIDO
}

enum DayCategory {
  CORPO
  MENTE
  ESPIRITO
}

enum TaskStatus {
  RASCUNHO
  AGENDADO
  ENVIANDO
  CONCLUIDO
  CANCELADO
}

enum TaskLogStatus {
  SUCESSO
  FALHA
}

// --------------------------------------------------------
// ORGANIZAÇÕES (O Topo da Pirâmide)
// --------------------------------------------------------

model Organization {
  id           String           @id @default(uuid())
  name         String           // Ex: "Prefeitura de Cajamar"
  description  String?          
  location     String?          
  cnpj         String?          // Adicionado caso precise para NFe/Cadastro
  
  type         OrganizationType @default(CUSTOMER)
  active       Boolean          @default(true)
  
  // Relações
  users        User[]           
  projects     Project[]        
  
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt

  @@map("organizations")
}

// --------------------------------------------------------
// USUÁRIOS
// --------------------------------------------------------

model User {
  id           String    @id @default(uuid())
  name         String
  email        String    @unique
  password     String    // Padronizado para 'password' para bater com o Controller
  
  // === CAMPO NOVO: AVATAR ===
  avatarUrl    String?   

  // === CARGO ATUALIZADO ===
  role         Role      @default(USUARIO)
  
  // O usuário pertence a UMA Organização
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Dados de Integração (WhatsApp/ManyChat)
  phone                 String?   @unique 
  manychatSubscriberId  String?   @unique 

  // Relações de uso do sistema
  subscriptions     Subscription[]   // Inscrições em jornadas
  actionLogs        ActionLog[]      // Diário/Logs de gamificação
  ranking           RankingSummary[] // Pontuação
  receivedMessages  TaskLog[]        // Histórico de msg recebidas
  
  // Controle de Tarefas (Se ele for responsável por criar/gerenciar)
  tasksCreated      Task[]           @relation("TaskCreator")

  deletedAt         DateTime? // Soft Delete
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  @@map("users")
}

// --------------------------------------------------------
// PROJETOS (Jornadas dentro da Organização)
// --------------------------------------------------------

model Project {
  id           String    @id @default(uuid())
  name         String
  description  String?
  
  startDate    DateTime?      
  endDate      DateTime?

  // O Projeto pertence a uma Organização
  organizationId String
  organization   Organization  @relation(fields: [organizationId], references: [id])
  
  isActive       Boolean       @default(true)
  
  // Relações
  tasks          Task[]        // Mensagens/Tarefas do projeto
  subscribers    Subscription[] // Pessoas inscritas
  
  // Legado (Gamificação)
  totalDays      Int           @default(21)
  dayTemplates   DayTemplate[]
  actionLogs     ActionLog[]
  ranking        RankingSummary[]
  
  // Integrações
  integrations   IntegrationSetting[]
  manychatConn   ManychatConnection[]
  
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt

  @@map("projects")
}

// --------------------------------------------------------
// AUTOMAÇÃO E MENSAGENS (Tarefas)
// --------------------------------------------------------

// Inscrição: Liga o Usuário ao Projeto
model Subscription {
  id        String   @id @default(uuid())
  active    Boolean  @default(true)
  
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  
  projectId String
  project   Project  @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, projectId])
  @@map("subscriptions")
}

// Tarefa (Pode ser uma Tarefa de Gestão OU uma Mensagem Agendada)
model Task {
  id           String     @id @default(uuid())
  title        String     // Nome interno da tarefa
  
  // Conteúdo (Se for mensagem) ou Descrição (Se for tarefa de gestão)
  content      String?    @db.Text 
  
  sendAt       DateTime?  // Data agendada (se for mensagem)
  deadline     DateTime?  // Prazo (se for tarefa de gestão)
  
  status       TaskStatus @default(RASCUNHO)
  isActive     Boolean    @default(true) // Para mostrar/esconder no dashboard
  
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id])

  // Quem criou ou é responsável por essa tarefa (Gestor)
  creatorId    String?
  creator      User?      @relation("TaskCreator", fields: [creatorId], references: [id])

  logs         TaskLog[]  // Histórico de disparos (se for mensagem)

  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@map("tasks")
}

// Log individual de envio (Auditoria de Mensagens)
model TaskLog {
  id        String        @id @default(uuid())
  status    TaskLogStatus
  error     String?
  sentAt    DateTime      @default(now())

  taskId    String
  task      Task          @relation(fields: [taskId], references: [id])

  userId    String        // Quem recebeu a mensagem
  user      User          @relation(fields: [userId], references: [id])

  @@map("task_logs")
}

// --------------------------------------------------------
// INTEGRAÇÕES E LEGADO
// --------------------------------------------------------

model IntegrationSetting {
  id            String   @id @default(uuid())
  name          String
  enabled       Boolean  @default(false)
  webhookSecret String?
  apiKey        String?
  configJson    Json?
  
  projectId     String?
  project       Project? @relation(fields: [projectId], references: [id])
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([name, projectId])
  @@map("integration_settings")
}

model ManychatConnection {
  id              String    @id @default(uuid())
  provider        String    @default("manychat")
  connected       Boolean   @default(false)
  accessToken     String?   @db.Text
  refreshToken    String?   @db.Text
  subscriberCount Int?      @default(0)
  lastSyncAt      DateTime?
  
  projectId       String?
  project         Project?  @relation(fields: [projectId], references: [id])
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@unique([provider, projectId])
  @@map("manychat_connections")
}

// Legado: Templates de Dia (Gamificação)
model DayTemplate {
  id            String      @id @default(uuid())
  
  projectId     String
  project       Project     @relation(fields: [projectId], references: [id])
  
  dayNumber     Int
  title         String
  description   String
  category      DayCategory
  points        Int         @default(1)
  requiresPhoto Boolean     @default(false)

  @@unique([projectId, dayNumber], name: "projectId_dayNumber")
  @@map("day_templates")
}

// Legado: Log de Ações do Usuário (Gamificação)
model ActionLog {
  id            String       @id @default(uuid())
  
  userId        String
  user          User         @relation(fields: [userId], references: [id])
  
  projectId     String
  project       Project      @relation(fields: [projectId], references: [id])
  
  dayNumber     Int
  status        ActionStatus @default(PENDENTE)
  photoUrl      String?
  notes         String?
  completedAt   DateTime?
  pointsAwarded Int          @default(0)
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  @@unique([userId, projectId, dayNumber], name: "userId_projectId_dayNumber")
  @@map("action_logs")
}

// Legado: Resumo do Ranking
model RankingSummary {
  userId        String
  projectId     String
  totalPoints   Int
  completedDays Int
  completionRate Float
  
  user          User    @relation(fields: [userId], references: [id])
  project       Project @relation(fields: [projectId], references: [id])

  @@id([userId, projectId])
  @@map("ranking_summaries")
}