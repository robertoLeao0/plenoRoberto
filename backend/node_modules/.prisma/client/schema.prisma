// ========================================================
// 1. CONFIGURAÇÕES GERAIS
// ========================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

// ========================================================
// 2. ENUMS (LISTAS DE OPÇÕES)
// ========================================================

// Níveis de acesso do sistema
enum Role {
  ADMIN // Super Admin (Pleno)
  GESTOR_ORGANIZACAO // Dono/Gerente da Empresa/Prefeitura
  USUARIO // Membro comum (user/Participante)
}

// Tipo da empresa
enum OrganizationType {
  CUSTOMER
  PARTNER
  INTERNAL
  SYSTEM
}

// Status de gamificação
enum ActionStatus {
  PENDENTE // Usuário ainda não fez nada
  EM_ANALISE // Usuário enviou, aguardando gestor
  APROVADO // Gestor aceitou
  REJEITADO // Gestor negou (vai usar o campo 'notes' para explicar)
}

// Categorias de tarefas diárias
enum DayCategory {
  CORPO
  MENTE
  ESPIRITO
}

// Status das Tarefas/Mensagens
enum TaskStatus {
  RASCUNHO
  AGENDADO
  ENVIANDO
  CONCLUIDO
  CANCELADO
}

// Status do envio de mensagem
enum TaskLogStatus {
  SUCCESS
  FAILED
  PENDING
}

// ========================================================
// 3. ORGANIZAÇÕES (TOPO DA HIERARQUIA)
// ========================================================

model Organization {
  id          String  @id @default(uuid())
  name        String // Ex: "Prefeitura de Cajamar"
  importToken String? @unique
  description String? // Descrição detalhada
  location    String?
  cnpj        String? // Para fins fiscais

  // === CONTROLE DE ACESSO ===
  // null = ATIVA | data = INATIVA (Soft Delete)
  deletedAt DateTime?

  type OrganizationType @default(CUSTOMER)

  // === RELACIONAMENTOS ===

  // 1. Gestor Principal (Quem manda na organização)
  managerId String?
  manager   User?   @relation("OrgManager", fields: [managerId], references: [id])

  // 2. Membros (Funcionários/Usuários vinculados)
  users User[] @relation("OrgMembers")

  // 3. Projetos (Que pertencem a esta organização)
  projects Project[]

  // 4. Tarefas (CORREÇÃO APLICADA)
  // Esse campo cria o relacionamento N:N (Muitos-para-Muitos).
  // O Prisma vai criar automaticamente uma tabela "_OrganizationToTask" no banco.
  tasks Task[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("organizations")
}

// ========================================================
// 4. USUÁRIOS (PESSOAS DO SISTEMA)
// ========================================================

model User {
  id       String  @id @default(uuid())
  name     String
  email    String  @unique
  cpf      String? @unique
  password String

  // === DADOS PESSOAIS ===
  avatarUrl String?
  phone     String? @unique

  // === PERMISSÕES E VÍNCULOS ===
  role Role @default(USUARIO)

  // 1. Membro de uma organização (Relação "OrgMembers")
  organizationId String?
  organization   Organization? @relation("OrgMembers", fields: [organizationId], references: [id])

  // 2. Gestor de várias organizações (Relação "OrgManager")
  managedOrganizations Organization[] @relation("OrgManager")

  // === INTEGRAÇÕES ===
  manychatSubscriberId String? @unique

  // === RELAÇÕES DE USO ===
  subscriptions    Subscription[] // Jornadas que participa
  actionLogs       ActionLog[] // Diário de gamificação
  ranking          RankingSummary[] // Pontuação acumulada
  receivedMessages TaskLog[] // Histórico de msgs recebidas

  // Tarefas que ele criou (se for Admin/Gestor)
  tasksCreated Task[] @relation("TaskCreator")

  // === CONTROLE ===
  deletedAt DateTime? // Soft Delete
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@map("users")
}

// ========================================================
// 5. PROJETOS (JORNADAS / CAMPANHAS)
// ========================================================

model Project {
  id          String  @id @default(uuid())
  name        String
  description String?

  startDate DateTime?
  endDate   DateTime?

  // === CONTROLE DE ACESSO (MUDANÇA AQUI) ===
  // Substitui o "isActive". 
  // Para buscar projetos ativos use: where: { deletedAt: null }
  deletedAt DateTime?

  // Relação Muitos-para-Muitos com Organizações
  organizations Organization[]

  // Mantido com valor padrão
  totalDays Int @default(30)

  // === CONTEÚDO E RELAÇÕES ===
  tasks       Task[]
  subscribers Subscription[]

  // === GAMIFICAÇÃO ===
  dayTemplates DayTemplate[]
  actionLogs   ActionLog[]
  ranking      RankingSummary[]

  // === INTEGRAÇÕES ===
  integrations IntegrationSetting[]
  manychatConn ManychatConnection[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("projects")
}

// ========================================================
// 6. AUTOMAÇÃO E MENSAGENS (TAREFAS)
// ========================================================

// Tabela Pivô: Quem está inscrito em qual Projeto
model Subscription {
  id     String  @id @default(uuid())
  active Boolean @default(true)

  userId String
  user   User   @relation(fields: [userId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, projectId])
  @@map("subscriptions")
}

// A Tarefa em si (Mensagem ou Atividade de Gestão)
model Task {
  id          String  @id @default(uuid())
  title       String // Título (ex: "DIA 1")
  description String? @db.Text

  startAt DateTime? // Data de liberação
  endAt   DateTime? // Data de bloqueio/fim

  // Status como String para evitar conflitos de Enum antigos
  status String @default("PENDING")

  requireMedia Boolean @default(false)
  isActive     Boolean @default(true)

  // === RELACIONAMENTO COM PROJETO (1:N) ===
  // Uma tarefa pertence a UM projeto. Aqui cria a coluna 'projectId'.
  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  // === RELACIONAMENTO COM ORGANIZAÇÕES (N:N) ===
  // Uma tarefa pode aparecer para VÁRIAS organizações.
  // O Prisma NÃO cria coluna 'organizationId' aqui. Ele cria uma tabela pivô automática.
  organizations Organization[]

  // === QUEM CRIOU ===
  creatorId String?
  creator   User?   @relation("TaskCreator", fields: [creatorId], references: [id])

  // === LOGS DE ENVIO ===
  logs TaskLog[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("tasks")
}

// Log de disparo (Para saber quem recebeu o que)
model TaskLog {
  id     String        @id @default(uuid())
  status TaskLogStatus
  error  String?
  sentAt DateTime      @default(now())

  taskId String
  task   Task   @relation(fields: [taskId], references: [id])

  userId String // Quem recebeu
  user   User   @relation(fields: [userId], references: [id])

  @@map("task_logs")
}

// ========================================================
// 7. GAMIFICAÇÃO (DIA A DIA)
// ========================================================

// O modelo do dia (Ex: Dia 1 - Beber Água)
model DayTemplate {
  id String @id @default(uuid())

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  dayNumber     Int
  title         String
  description   String
  category      DayCategory
  points        Int         @default(1)
  requiresPhoto Boolean     @default(false)

  @@unique([projectId, dayNumber], name: "projectId_dayNumber")
  @@map("day_templates")
}

// O registro do usuário (A foto/prova que ele enviou)
model ActionLog {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id])

  projectId String
  project   Project @relation(fields: [projectId], references: [id])

  dayNumber Int
  status    ActionStatus @default(PENDENTE)

  photoUrl String? // A prova do usuário
  notes    String? // <--- AQUI VAI O COMENTÁRIO DO GESTOR

  completedAt   DateTime?
  pointsAwarded Int       @default(0)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  @@unique([userId, projectId, dayNumber], name: "userId_projectId_dayNumber")
  @@map("action_logs")
}

// Resumo dos pontos (Ranking)
model RankingSummary {
  userId         String
  projectId      String
  totalPoints    Int
  completedDays  Int
  completionRate Float

  user    User    @relation(fields: [userId], references: [id])
  project Project @relation(fields: [projectId], references: [id])

  @@id([userId, projectId])
  @@map("ranking_summaries")
}

// ========================================================
// 8. INTEGRAÇÕES (WHATSAPP/MANYCHAT)
// ========================================================

model IntegrationSetting {
  id            String  @id @default(uuid())
  name          String
  enabled       Boolean @default(false)
  webhookSecret String?
  apiKey        String?
  configJson    Json?

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, projectId])
  @@map("integration_settings")
}

// ========================================================
// 9. MENSAGENS AGENDADAS (NOVA TABELA NECESSÁRIA)
// ========================================================
// Adicionei isso para corrigir o erro "Property scheduledMessage does not exist"
model ScheduledMessage {
  id          String   @id @default(uuid())
  projectId   String?
  title       String
  body        String   @db.Text
  mediaUrl    String?
  targetType  String   @default("project")
  targetValue String?
  scheduledAt DateTime
  repeatCron  String?
  status      String   @default("scheduled")
  lastResult  Json?
  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("scheduled_messages")
}

model ManychatConnection {
  id              String    @id @default(uuid())
  provider        String    @default("manychat")
  connected       Boolean   @default(false)
  accessToken     String?   @db.Text
  refreshToken    String?   @db.Text
  subscriberCount Int?      @default(0)
  lastSyncAt      DateTime?

  projectId String?
  project   Project? @relation(fields: [projectId], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([provider, projectId])
  @@map("manychat_connections")
}
